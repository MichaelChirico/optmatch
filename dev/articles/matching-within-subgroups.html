<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="optmatch">
<title>Combining Matches Within Subgroups • optmatch</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Combining Matches Within Subgroups">
<meta property="og:description" content="optmatch">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">optmatch</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.10.3.9001</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/fullmatch-vignette.html">Matching in R using the optmatch and RItools packages</a>
    <a class="dropdown-item" href="../articles/matching-from-foreign-software.html">Using Optmatch on data in SAS, Stata, etc</a>
    <a class="dropdown-item" href="../articles/matching-within-subgroups.html">Combining Matches Within Subgroups</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/markmfredrickson/optmatch/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="matching-within-subgroups_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Combining Matches Within Subgroups</h1>
                        <h4 data-toc-skip class="author">Ben B. Hansen, Mark Fredrickson, Josh Errickson, Josh Buckner</h4>
            
            <h4 data-toc-skip class="date">2022-05-26</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/markmfredrickson/optmatch/blob/HEAD/vignettes/matching-within-subgroups.Rmd" class="external-link"><code>vignettes/matching-within-subgroups.Rmd</code></a></small>
      <div class="d-none name"><code>matching-within-subgroups.Rmd</code></div>
    </div>

    
    
<p>When utilizing full matching, a user may want to introduce restrictions to the potential match sets. There are two main reasons to do this.</p>
<ul>
<li>There may be certain variables which matches should either always or never agree upon. For example, if there is a binary gender variable, you may wish to only match treatment members to control members of the same gender.</li>
<li>When matching on a medium-to-large data set, speed concerns can become paramount. By splitting the matching problem into a series of smaller subproblems, we can realize substantial performance improvements.</li>
</ul>
<div class="section level2">
<h2 id="combining-matches">Combining matches<a class="anchor" aria-label="anchor" href="#combining-matches"></a>
</h2>
<p>In optmatch 0.9-11 and above, <code>optmatch</code> objects can be easily combined to facilitate breaking a problem into smaller sub-problems and reconstituting a matched structure on the entire data set. To demonstrate this, let’s consider the <code>infert</code> data set.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="op">&gt;</span><span class="st"> </span><span class="kw">data</span>(infert)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="op">&gt;</span><span class="st"> </span><span class="kw">head</span>(infert)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co">##   education age parity induced case spontaneous stratum pooled.stratum</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co">## 1    0-5yrs  26      6       1    1           2       1              3</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co">## 2    0-5yrs  42      1       1    1           0       2              1</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co">## 3    0-5yrs  39      6       2    1           0       3              4</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co">## 4    0-5yrs  34      4       2    1           0       4              2</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co">## 5   6-11yrs  35      3       1    1           1       5             32</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co">## 6   6-11yrs  36      4       2    1           1       6             36</span></span></code></pre></div>
<p>The “case” variable indicates treatment (1) versus control (0) status. We’ll want to match upon “age”.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="op">&gt;</span><span class="st"> </span><span class="kw">table</span>(infert<span class="op">$</span>case)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">## </span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co">##   0   1 </span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co">## 165  83</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="op">&gt;</span><span class="st"> </span><span class="kw">table</span>(infert<span class="op">$</span>education, infert<span class="op">$</span>case)</span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="co">##          </span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co">##            0  1</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co">##   0-5yrs   8  4</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="co">##   6-11yrs 80 40</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="co">##   12+ yrs 77 39</span></span></code></pre></div>
<p>Due to the sample size, if we were to compute matches on the entire data set, the <code>fullmatch</code> call would generate a distance matrix of size <span class="math inline">\(165\times 83 = 13,695\)</span>. However, if we were instead to compute a match within each level of the “education” variable, we’d compute three different distance matrices, of total size <span class="math inline">\(8\times 4 + 80\times 40 + 77\times 39 = 6,235\)</span>, a reduction of 55%.</p>
<p>We’ll do this by splitting the data within each match.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="op">&gt;</span><span class="st"> </span>f1 &lt;-<span class="st"> </span><span class="kw">fullmatch</span>(case <span class="op">~</span><span class="st"> </span>age, <span class="dt">data =</span> infert[infert<span class="op">$</span>education <span class="op">==</span><span class="st"> "0-5yrs"</span>, ])</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="op">&gt;</span><span class="st"> </span>f2 &lt;-<span class="st"> </span><span class="kw">fullmatch</span>(case <span class="op">~</span><span class="st"> </span>age, <span class="dt">data =</span> infert[infert<span class="op">$</span>education <span class="op">==</span><span class="st"> "6-11yrs"</span>, ])</span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="op">&gt;</span><span class="st"> </span>f3 &lt;-<span class="st"> </span><span class="kw">fullmatch</span>(case <span class="op">~</span><span class="st"> </span>age, <span class="dt">data =</span> infert[infert<span class="op">$</span>education <span class="op">==</span><span class="st"> "12+ yrs"</span>, ])</span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="op">&gt;</span><span class="st"> </span><span class="kw">summary</span>(f1)</span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co">## Structure of matched sets:</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co">## 1:2 </span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co">##   4 </span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="co">## Effective Sample Size:  5.3 </span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co">## (equivalent number of matched pairs).</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="op">&gt;</span><span class="st"> </span><span class="kw">summary</span>(f2)</span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="co">## Structure of matched sets:</span></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="co">##  1:1  1:2  1:3  1:4 1:5+ </span></span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="co">##   20    8    6    4    2 </span></span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="co">## Effective Sample Size:  49.4 </span></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="co">## (equivalent number of matched pairs).</span></span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="op">&gt;</span><span class="st"> </span><span class="kw">summary</span>(f3)</span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="co">## Structure of matched sets:</span></span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="co">##  1:1  1:2  1:3  1:4 1:5+ </span></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="co">##   23    5    6    2    3 </span></span>
<span id="cb3-20"><a href="#cb3-20"></a><span class="co">## Effective Sample Size:  47 </span></span>
<span id="cb3-21"><a href="#cb3-21"></a><span class="co">## (equivalent number of matched pairs).</span></span></code></pre></div>
<p>Some of the matched sets are quite large (1:5+) so let’s put some restrictions.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="op">&gt;</span><span class="st"> </span>f2 &lt;-<span class="st"> </span><span class="kw">fullmatch</span>(case <span class="op">~</span><span class="st"> </span>age, <span class="dt">data =</span> infert[infert<span class="op">$</span>education <span class="op">==</span><span class="st"> "6-11yrs"</span>, ],</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="op">+</span><span class="st">                 </span><span class="dt">max.controls =</span> <span class="dv">4</span>)</span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="op">&gt;</span><span class="st"> </span>f3 &lt;-<span class="st"> </span><span class="kw">fullmatch</span>(case <span class="op">~</span><span class="st"> </span>age, <span class="dt">data =</span> infert[infert<span class="op">$</span>education <span class="op">==</span><span class="st"> "12+ yrs"</span>, ],</span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="op">+</span><span class="st">                 </span><span class="dt">max.controls =</span> <span class="dv">4</span>)</span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="op">&gt;</span><span class="st"> </span><span class="kw">summary</span>(f2)</span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">## Structure of matched sets:</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co">## 1:1 1:2 1:3 1:4 </span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="co">##  18  10   6   6 </span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co">## Effective Sample Size:  49.9 </span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="co">## (equivalent number of matched pairs).</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="op">&gt;</span><span class="st"> </span><span class="kw">summary</span>(f3)</span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="co">## Structure of matched sets:</span></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="co">## 1:1 1:2 1:3 1:4 </span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="co">##  20   6   7   6 </span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="co">## Effective Sample Size:  48.1 </span></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="co">## (equivalent number of matched pairs).</span></span></code></pre></div>
<p>Now we simply combine the three matches.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="op">&gt;</span><span class="st"> </span>fcombine &lt;-<span class="st"> </span><span class="kw">c</span>(f1, f2, f3)</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="op">&gt;</span><span class="st"> </span><span class="kw">summary</span>(fcombine)</span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co">## Structure of matched sets:</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co">## 1:1 1:2 1:3 1:4 </span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="co">##  38  20  13  12 </span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="co">## Effective Sample Size:  103.4 </span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="co">## (equivalent number of matched pairs).</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="op">&gt;</span><span class="st"> </span>infert<span class="op">$</span>match &lt;-<span class="st"> </span>fcombine</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="using-the-within-argument">Using the <code>within</code> argument<a class="anchor" aria-label="anchor" href="#using-the-within-argument"></a>
</h2>
<p>An alternative approach would be using the <code>within</code> argument and the <code>exactMatch</code> function to define subproblems.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="op">&gt;</span><span class="st"> </span>fwithin &lt;-<span class="st"> </span><span class="kw">fullmatch</span>(case <span class="op">~</span><span class="st"> </span>age, <span class="dt">data =</span> infert, <span class="dt">max.controls =</span> <span class="dv">4</span>,</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="op">+</span><span class="st">                      </span><span class="dt">within =</span> <span class="kw">exactMatch</span>(case <span class="op">~</span><span class="st"> </span>education, <span class="dt">data =</span> infert))</span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="op">&gt;</span><span class="st"> </span><span class="kw">summary</span>(fwithin)</span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co">## Structure of matched sets:</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">## 1:1 1:2 1:3 1:4 </span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="co">##  38  20  13  12 </span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co">## Effective Sample Size:  103.4 </span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co">## (equivalent number of matched pairs).</span></span></code></pre></div>
<p>Observe that we obtain equivalent matched structure. A few notes comparing the two approaches:</p>
<ol style="list-style-type: decimal">
<li>
<p>When using the <code>within</code> argument, restrictions must be the same across subproblems. That is, <code>max.controls</code>, <code>min.controls</code> and <code>omit.fraction</code> will be equivalent. By running the subproblems separately, you can set different restrictions per subproblem. E.g.,</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="op">&gt;</span><span class="st"> </span>f1 &lt;-<span class="st"> </span><span class="kw">fullmatch</span>(z <span class="op">~</span><span class="st"> </span>x, <span class="dt">data =</span> d[d<span class="op">$</span>group <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, ], <span class="dt">max.controls =</span> <span class="dv">2</span>)</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="op">&gt;</span><span class="st"> </span>f2 &lt;-<span class="st"> </span><span class="kw">fullmatch</span>(z <span class="op">~</span><span class="st"> </span>x, <span class="dt">data =</span> d[d<span class="op">$</span>group <span class="op">==</span><span class="st"> </span><span class="dv">2</span>, ], <span class="dt">min.controls =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>)</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="op">&gt;</span><span class="st"> </span><span class="kw">c</span>(f1, f2)</span></code></pre></div>
</li>
<li><p>While the matched structures will be equivalent between these two approaches (if the restrictions are the same across subproblems), the actual matched sets themselves may differ if you have observations of equal distance. In general this should not be considered a problem.</p></li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Ben Hansen, Mark Fredrickson, Josh Errickson, Josh Buckner.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
