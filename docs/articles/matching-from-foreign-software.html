<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="optmatch">
<title>Using Optmatch on data in SAS, Stata, etc • optmatch</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using Optmatch on data in SAS, Stata, etc">
<meta property="og:description" content="optmatch">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">optmatch</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.10.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/fullmatch-vignette.html">Matching in *R* using the `optmatch` and `RItools` packages</a>
    <a class="dropdown-item" href="../articles/matching-from-foreign-software.html">Using Optmatch on data in SAS, Stata, etc</a>
    <a class="dropdown-item" href="../articles/matching-within-subgroups.html">Combining Matches Within Subgroups</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/markmfredrickson/optmatch/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Using Optmatch on data in SAS, Stata, etc</h1>
                        <h4 data-toc-skip class="author">Ben B. Hansen, Mark Fredrickson, Josh Buckner, Josh Errickson, and Peter Solenberger, with embedded Fortran code due to Dimitri P. Bertsekas and Paul Tseng</h4>
            
            <h4 data-toc-skip class="date">2022-03-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/markmfredrickson/optmatch/blob/HEAD/vignettes/matching-from-foreign-software.Rmd" class="external-link"><code>vignettes/matching-from-foreign-software.Rmd</code></a></small>
      <div class="d-none name"><code>matching-from-foreign-software.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="general-comments">General comments<a class="anchor" aria-label="anchor" href="#general-comments"></a>
</h2>
<p>If a users preferred data analysis software is other than R, Optmatch can still easily be used to perform the matching while all other data analysis can be performed in the preferred software.</p>
<p>In general, the procedure will be</p>
<ol style="list-style-type: decimal">
<li>In your preferred software, export a data set containing a treatment indicator and all variables to match, exactMatch or caliper on.
<ul>
<li>(Optionally, if you wish to match using a propensity score, fit such a model and include the predicted propensity scores in the data set.)</li>
</ul>
</li>
<li>Import the data into R.</li>
<li>Perform the matching in R.</li>
<li>Export the data from R, including the matches.</li>
<li>Import the data back into your preferred software.</li>
</ol>
<p>The most general way to import the data back-and-forth are using comma separated value files (.csv files), which any statistical software should be able to read &amp; write.</p>
<p>For .csv files, sample R code may be</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> externaldata <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"externaldata.csv"</span>, <span class="at">header=</span><span class="cn">TRUE</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> externaldata<span class="sc">$</span>match <span class="ot">&lt;-</span> <span class="fu">fullmatch</span>(..., <span class="at">data=</span>externaldata)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">write.csv</span>(externaldata, <span class="at">file=</span><span class="st">"externaldata.matched.csv"</span>)</span></code></pre></div>
<p>For SAS and Stata, there are R packages which can make the importing/exporting easier, and are document below.</p>
</div>
<div class="section level2">
<h2 id="using-optmatch-with-sas">Using Optmatch with SAS<a class="anchor" aria-label="anchor" href="#using-optmatch-with-sas"></a>
</h2>
<p>For this example, lets say we have some simple demographics. We will treat gender as the treatment indicator, and wish to match on a combination of a propensity score for gender (using both age and height) and age.</p>
<pre class="sas"><code>data people;
  infile datalines dsd dlm=' ' missover;
  input gender age height;

datalines;
0 25 62
0 41 68
0 38 63
0 22 62
1 33 70
1 35 71
1 47 68
1 23 64
;
run;</code></pre>
<p>Now we can fit a logistic model to predict gender using age and height.</p>
<pre class="sas"><code>proc logistic data = people;
  model gender (event='1') = age height;
  output out = preddata p=ppty;
run;</code></pre>
<p>Finally, since we want to match only on the new <code>ppty</code> propensity score and age, we can drop height.</p>
<pre class="sas"><code>proc data newpeople;
  set preddata;
  keep gender age ppty;
run;</code></pre>
<p>With this setup, we can now either pass it to R via a .csv file, or directly using the foreign package in R.</p>
<div class="section level3">
<h3 id="passing-sas-data-with--csv-files">Passing SAS data with .csv files<a class="anchor" aria-label="anchor" href="#passing-sas-data-with--csv-files"></a>
</h3>
<p>Save the file from SAS.</p>
<pre class="sas"><code>proc export data=newpeople;
  outfile="C:\Users\myuser\Desktop\sasout.csv";
run;</code></pre>
<p>Inside R, we can load this data.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> sasdata <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"C:/Users/myuser/Desktop/sasout.csv"</span>, <span class="at">header=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<p>(Depending on your version of Windows, you may need to use</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> sasdata <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"C:</span><span class="sc">\\</span><span class="st">Users</span><span class="sc">\\</span><span class="st">myuser</span><span class="sc">\\</span><span class="st">Desktop</span><span class="sc">\\</span><span class="st">sasout.csv"</span>, <span class="at">header=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<p>instead.)</p>
<p>If you have string variables (e.g. race as “White”, “Hispanic”, etc), you may need to include the argument <code>stringsAsFactors=FALSE</code>.</p>
<p>Now, perform matching as desired, saving the final match to <code>sasdata</code>. For example,</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(optmatch)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> f <span class="ot">&lt;-</span> <span class="fu">fullmatch</span>(gender <span class="sc">~</span> age <span class="sc">+</span> ppty, <span class="at">data=</span>sasdata)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> sasdata<span class="sc">$</span>match <span class="ot">&lt;-</span> f</span></code></pre></div>
<p>Save this data back to .csv as follows.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">write.csv</span>(sasdata, <span class="st">"C:/Users/myuser/Desktop/rout.sas.csv"</span>, <span class="at">row.names=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<p>The use of <code>row.names=FALSE</code> stops R from including the row names (likely 1, 2, 3, etc) as the first column in the data. If you re-arranged the data at any point, you may need to set that to <code>TRUE</code>, but keep in mind to handle it properly in SAS, as the default will be to treat it as a variable.</p>
<p>Now, returning to SAS, we can read the new rout.sas.csv file in. The only catch is that we want to ensure that the match is read as a string by using <code>$</code>, since it may have values like <code>1.1</code> and <code>1.10</code>, representing two different matches, but which are identical if treated as numeric.</p>
<pre class="sas"><code>data matchedpeople;
  infile "C:/Users/myuser/Desktop/rout.sas.csv" dsd firstobs=2;
  input gender age ppty match $;
run;</code></pre>
<p>The argument <code>firstobs=2</code> skips the variable names; alternatively you could pass <code>col.names=FALSE</code> to R’s <code>write.csv</code>, but then the rout.sas.csv file lacks any variable information, which may be useful to have.</p>
</div>
<div class="section level3">
<h3 id="passing-sas-data-with-rs-foreign">Passing SAS data with R’s foreign<a class="anchor" aria-label="anchor" href="#passing-sas-data-with-rs-foreign"></a>
</h3>
<p>As an alternative to using R’s <code>write.csv</code>, you can use the R package foreign to generate both the data and SAS code needed.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(foreign)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">write.foreign</span>(sasdata, <span class="st">'C:/Users/myuser/Desktop/rout.sas.txt'</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="sc">+</span>               <span class="st">'C:/Users/myuser/Desktop/rout.code.sas'</span>, <span class="at">package =</span> <span class="st">'SAS'</span>)</span></code></pre></div>
<p>Opening the rout.code.sas file will give you the SAS code to read in the data.</p>
</div>
</div>
<div class="section level2">
<h2 id="using-optmatch-with-stata">Using Optmatch with Stata<a class="anchor" aria-label="anchor" href="#using-optmatch-with-stata"></a>
</h2>
<p>For this example, we will start with the built-in auto data set in Stata.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sysuse</span> auto.dta</span></code></pre></div>
<p>We will treat <code>foreign</code>, whether a car is domestic or foreign, as the treatment indicator. (Not to be confused with the R package foreign!) We will estimate propensity scores using all other variables (excluding <code>make</code> which is unique per row), and wish to match on the estimated propensity score as well as <code>price</code> and <code>mpg</code>.</p>
<p>First, lets fit the logistic regression model.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">logit</span> foreign price mpg rep78 headroom trunk <span class="kw">weight</span> <span class="fu">length</span> turn displacement gear_ratio</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> ppty, <span class="kw">xb</span></span></code></pre></div>
<p>Note that in addition to the treatment indicator and variables to match on, we need to include a unique identifier. In this case, we can use <code>make</code>. If no such identifier exists, you could use</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> case_id = <span class="dt">_n</span></span></code></pre></div>
<p>to generate ID’s 1, 2, etc. These will be needed to merge the match information back in.</p>
<p>We’ll save only the relevant variables (treatment indicator, anything to be matched on (including propensity score), and an ID variable to merge on) to avoid saving and loading a very large file.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">preserve</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">keep</span> make foreign price mpg ppty</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> <span class="st">"C:\Users\myuser\Desktop</span><span class="ch">\t</span><span class="st">oR.dta"</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="kw">restore</span></span></code></pre></div>
<p>Turning to R, this can be read in using the “haven” package</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(haven)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> statadata <span class="ot">&lt;-</span> <span class="fu">read_dta</span>(<span class="st">"C:/Users/myuser/Desktop/toR.dta"</span>)</span></code></pre></div>
<p>(Again, depending on your version of Windows, you may need to use</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> statadata <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"C:</span><span class="sc">\\</span><span class="st">Users</span><span class="sc">\\</span><span class="st">myuser</span><span class="sc">\\</span><span class="st">Desktop</span><span class="sc">\\</span><span class="st">stataout.csv"</span>, <span class="at">header=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<p>instead.)</p>
<p>If you have string variables (e.g. race as “White”, “Hispanic”, etc), you may need to include the argument <code>stringsAsFactors=FALSE</code>.</p>
<p>Now, perform matching as desired, saving the final match to <code>statadata</code>. For example,</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(optmatch)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> statadata<span class="sc">$</span>match <span class="ot">&lt;-</span> <span class="fu">fullmatch</span>(foreign <span class="sc">~</span> price <span class="sc">+</span> mpg <span class="sc">+</span> ppty, <span class="at">data=</span>statadata, <span class="at">max.controls=</span><span class="dv">3</span>)</span></code></pre></div>
<p>We’ll use haven again to write the data back to Stata. We do not recommend using .csv files to transfer the data back to Stata, though the <code>write.csv</code> file would be similar to that for SAS.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">write_dta</span>(statadata, <span class="st">"C:/Users/myuser/Desktop/rout.stata.dta"</span>)</span></code></pre></div>
<p>Back in Stata, you can merge this into the existing data set by the following commands:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span> make</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> 1:1 make <span class="kw">using</span> <span class="st">"C:/Users/myuser/Desktop/rout.stata.dta"</span>, <span class="kw">force</span></span></code></pre></div>
<p>The <code>force</code> option is necessary to overcome type differences. Additional tweaks may be necessary here if you have special variable types.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Ben Hansen, Mark Fredrickson, Josh Errickson, Josh Buckner.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
